<!DOCTYPE HTML>
<html>
<head>

<meta charset="utf-8">
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="-1" />
<meta http-equiv="Cache-Control" content="no-cache" />

<meta name="viewport" content="user-scalable=no, width=device-width, height=device-height, initial-scale=1, minimum-scale=1, maximum-scale=1" />
<meta name="apple-touch-fullscreen" content="yes" />
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">

<title>Toucher Demo 1</title>
	
<link href="demo.css" rel="stylesheet" charset="utf-8" />

<script src="./demo.js"></script>

<script src="../src/Controller.js"></script>
<script src="../src/TouchWrapper.js"></script>
<script src="../src/Listener.js"></script>

<script src="../src/custom/Scroll.js"></script>

<style>
body : {
	overflow: hidden;

}

</style>
<script>


window.onload=function(){

	createGrid();

	initToucher();
}


//创建一个tap listener的实例
var testTouch=new Toucher.Scroll({

	touchCount : 1 ,

	filterWrapper : function(touchWrapper,event,controller){
		var t=touchWrapper.target;
		var v= t==grid 
			|| t==table 
			|| t.parentNode.parentNode==table
			|| t==gridBox;

		if (v){
			clearTimeout(current);

		}
		return v
	},

	onScroll : function(dx,dy,touchWrappers,event,controller){
		
			var y=grid.y+dy;

			grid.y=y;

			setDomPos( grid, 0, grid.y );

	},

	end : function(touchWrappers, event, controller){ 
		var touchWrapper=touchWrappers[0];
		var time=touchWrapper.endTime-touchWrapper.startTime;
		var distance=touchWrapper.endPageY-touchWrapper.startPageY;
		var speed=distance/time;
		if (Math.abs(speed)>0.5){
			startScroll(grid,speed);
		}
	} 
});

var current=null
function startScroll(grid,speed){
	var up=speed<0;

	var acc=up?0.001:-0.001;

	var y=grid.y;
	clearTimeout(current)
	speed=speed*1;

	function run(){

		var deltaTime=20;

		var lastSpeed=speed;

		speed=speed + acc * deltaTime;

		if (speed*lastSpeed<=0){
			return;
		}

		var dy=(lastSpeed + speed) * deltaTime / 2 ;	

		y=y+dy;

		if (y>10){
			y=0;
		}

		setDomPos( grid, 0, y );
		grid.y=y;


		current=setTimeout(run,20);


		

	}

	run()

}

var controller=new Toucher.Controller({
	beforeInit : function(){
		this.dom=document.body;
	},
	preventDefaultMove :true
});


function initToucher(){
	controller.init();

	//把自定义事件注册到controller里
	controller.addListener(testTouch);
}


var table, grid,gridBox;
var gridSize=2000;
function createGrid(){


	var canvas=document.createElement("canvas");
	canvas.width=125;
	canvas.height=100;
	var ctx=canvas.getContext("2d");

	ctx.strokeRect(10,10,canvas.width-20,canvas.height-20);
	var dataUrl=canvas.toDataURL();

	gridBox=document.createElement("div");
	gridBox.style.border="solid 1px red"
	gridBox.style.position="relative";
	gridBox.style.overflow="hidden";
	gridBox.style.backgroundColor="white" ;

	gridBox.w=window.innerWidth-20;
	gridBox.h=window.innerHeight-20;

	gridBox.style.width= gridBox.w+"px";
	gridBox.style.height=gridBox.h+"px";

	grid=document.createElement("div");
	var style={
		position : "absolute",
		
		//backgroundImage : "url("+dataUrl+")",
		top : "0px",
		left : "0px",
		width : "100%"
		//width : gridSize+"px",
		//height : gridSize+"px"
	}

	for (var p in style){
		grid.style[p]=style[p];
	}

	table=document.createElement("table");
	table.width="100%"
	table.style.width="100%"
	for (var i=0;i<300;i++){
		var tr=document.createElement("tr");
		var td=document.createElement("td");
		tr.appendChild( td );
		td.innerHTML=i+" test test test ";
		td.style.fontSize="24pt"
		td.style.padding="5pt"
		td.style.borderBottom="1px solid #666666"
		td.style.color="black"
		table.appendChild(tr);
	}
	grid.appendChild(table)

	grid.x=0;
	grid.y=0;

	gridBox.appendChild( grid );
	document.body.appendChild( gridBox );




}

	</script>

</head>
<body >
<div id="info">info</div>


</body>

</html>
